---
alwaysApply: true
---

# Cursor Rules for WolfArchiver

## 指示概要

このプロジェクト「WolfArchiver」はCGIベースの人狼ゲームサイトをアーカイブ化するRubyアプリケーションです。Cursor AIに対する開発支援では、以下の指示を優先してください。

## 重要な指示

### 1. 仕様書の参照（最優先）

**必ず以下の仕様書を参照してからコード生成・修正を行ってください。**

- 実装するモジュール対応の仕様書を `spec/` ディレクトリから確認
- 仕様書に書かれた「インターフェース」「処理フロー」「エラーハンドリング」に従う
- 仕様書の「テストケース」セクションを参考にテストを作成

**仕様書ファイル一覧:**
- `spec/config_loader_spec.md` - 設定ファイル読み込み
- `spec/encoding_converter_spec.md` - 文字エンコーディング変換
- `spec/rate_limiter_spec.md` - リクエスト間隔制限
- `spec/fetcher_spec.md` - HTTP通信
- `spec/parser_spec.md` - HTML解析
- `spec/storage_spec.md` - ファイルシステム管理
- `spec/link_rewriter_spec.md` - リンク書き換え
- `spec/asset_downloader_spec.md` - アセットダウンロード
- `spec/wolf_archiver_spec.md` - メインクラス・CLI

### 2. コード変更時の手順

1. **仕様書を読む** → 実装するモジュールの仕様を確認
2. **ファイル構造を確認** → `lib/wolf_archiver/` 下のモジュール配置を確認
3. **既存コードを確認** → 同様のパターンが存在するかチェック
4. **仕様に従う** → インターフェース、エラー処理、ログ出力を正確に実装
5. **テストを追加** → 仕様書のテストケースを実装

### 3. アーキテクチャの理解

```
WolfArchiver（メインクラス）
├── ConfigLoader（設定読み込み）
├── RateLimiter（リクエスト制限）
├── Fetcher（HTTP通信）
├── EncodingConverter（文字コード変換）
├── Parser（HTML解析）
├── Storage（ファイル管理）
├── PathMapper（URL→パス変換）
├── LinkRewriter（リンク書き換え）
└── AssetDownloader（アセット取得）
```

**各モジュールの責務は独立している** ため、相互依存を最小限にしてください。

### 4. エラーハンドリング

- **個別エラー** → 適切なカスタムエラークラスを使用（例: `ConfigError`, `FetchError`）
- **部分的失敗** → 全体処理を停止せず、エラーを記録して継続
- **ログ出力** → エラーレベルに応じて DEBUG/INFO/WARN/ERROR を使い分け

**エラークラス一覧:**
```ruby
WolfArchiverError（基底）
├── ConfigError
├── EncodingError
├── FetchError
├── ParserError
├── StorageError
├── PathMapperError
├── LinkRewriterError
└── AssetDownloaderError
```

### 5. ログ出力の原則

| レベル | 用途 | 例 |
|--------|------|-----|
| DEBUG | 詳細情報（開発用） | "URL解決: http://... → ..." |
| INFO | 通常の処理進捗 | "ページ処理開始" |
| WARN | 軽微な問題 | "アセットマッピング不可" |
| ERROR | 個別処理失敗 | "ダウンロード失敗" |

### 6. テスト作成時の注意

- 仕様書の「テストケース」セクションを参考にする
- 正常系・異常系・エッジケースをバランスよく
- モジュール単体テストと統合テストを区別
- RSpec を使用

### 7. 文字列・パス処理

- **相対URL解決** → `Addressable::URI` を使用
- **文字エンコーディング** → `EncodingConverter` を必ず使用
- **ファイルパス** → `Pathname` と `File.join` で統一
- **パストラバーサル対策** → `..` を含むパスを拒否

### 8. 設定ファイル仕様

- **フォーマット** → YAML
- **必須項目** → `name`, `base_url`, `encoding`, `wait_time`
- **デフォルト値** → ConfigLoader で自動マージ
- **検証** → ConfigLoaderで厳密に実施

### 9. git コミットメッセージの形式

```
[モジュール名] 変更内容（簡潔に）

詳細説明があれば記載
```

例：
```
[Parser] HTML解析時のバイナリデータ対応
- バイナリストリームの正確な処理
- エンコーディング情報のクリア
```

### 10. パフォーマンス考慮

- **重複除去** → `Set` を使用
- **キャッシュ** → 相対パス計算など頻繁な処理
- **メモリ** → 大量データは逐次処理（配列キャッシュ不可）
- **ログ** → 本番環境では INFO レベル以上のみ

## 仕様を無視してはいけない例

❌ **悪い例：仕様を無視**
```ruby
# FetchError で全体を停止（仕様では部分失敗を許容）
raise FetchError, "個別のアセット取得失敗"
```

✅ **良い例：仕様に従う**
```ruby
# failed配列に追加して処理継続
failed << { url: asset.url, error: e.message }
```

---

❌ **悪い例：勝手なエラーハンドリング**
```ruby
# 仕様にない例外処理
rescue StandardError => e
  # 無視
end
```

✅ **良い例：仕様に従う**
```ruby
# ConfigError など定義されたエラーを使用
rescue ConfigError => e
  # 処理
end
```

---

❌ **悪い例：仕様にないログ出力レベル**
```ruby
logger.trace("詳細...")  # trace は仕様にない
```

✅ **良い例：仕様に従う**
```ruby
logger.debug("詳細...")  # 仕様では DEBUG を使用
```

## よくある質問と回答

### Q: 新しいメソッドを追加する場合？
A: 対応する仕様書を確認し、「インターフェース」セクションに記載があるか確認してください。ない場合は、仕様を拡張する必要があります。

### Q: 外部Gemを追加する場合？
A: Gemfile を更新し、使用理由を記載してください。仕様に関連のないGemは避けてください。

### Q: テストを書く場合？
A: 仕様書の「テストケース」セクションを参考に、正常系・異常系・エッジケースをカバーしてください。

### Q: 既存コードを修正する場合？
A: 修正前に、仕様書で規定されている動作と現在のコードを比較し、乖離を確認してください。

## リソース

- **仕様書** → `/spec/` ディレクトリ
- **実装** → `/lib/wolf_archiver/` ディレクトリ
- **設定** → `/config/sites.yml`
- **実行** → `./bin/wolf_archiver`
- **テスト** → `/test/` ディレクトリ

## 最後に

**仕様書は真実です。** コード生成・修正の際は、常に対応する仕様書を参照してください。仕様と異なる実装は、後の保守を困難にします。

---

**このCursor Rulesは、プロジェクト開発中に更新される可能性があります。最新版を常に参照してください。**
